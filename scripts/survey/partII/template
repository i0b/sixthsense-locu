PART="partII"
PARTICIPANT_NUMBER="$1"
SEQUENCE_NUMBER="0"

source config

PARAMETER="255"

INTENSITY1="0"
INTERVAL1="0"
INTENSITY2="0"
INTERVAL2="0"

SHOW_VALUES="yes"

function loadIntensity {
  declare -a 'values=('"$1"')'
  #eval values=($1)
  INTENSITY1=${values[0]}
  INTERVAL1=${values[1]}
  INTENSITY2=${values[2]}
  INTERVAL2=${values[3]}
}

function applyValues {
  echo "sm $ACTUATOR $ACTUATOR_MODE six/0.1" > $PORT
  echo "sp $ACTUATOR $PARAMETER six/0.1" > $PORT

  if [ "$1" == "showValues" ]; then
    echo "Intensity: $INTENSITY1" > $TTY
  fi

  echo "si $ACTUATOR $INTENSITY1 six/0.1" > $PORT
  sleep "$INTERVAL1"


  if [ "$1" == "showValues" ]; then
    echo "Intensity: $INTENSITY2" > $TTY
  fi

  echo "si $ACTUATOR $INTENSITY2 six/0.1" > $PORT
  sleep "$INTERVAL2"

  echo "sm $ACTUATOR OFF six/0.1" > $PORT
}

function printResolution {
  RESOLUTION=$(echo $1 | sed -e 's/.*_\([0-9]*\).txt/\1/g')
  if [ -n $RESOLUTION ]; then
    echo "you will feel a resolution of $RESOLUTION now"
  fi
}

function runBatchFile {
  while read line; do
    loadIntensity "$line"

    applyValues $1

    if [ "$1" == "test" ]; then
      echo "please enter the intensity levels you felt"
      read -p "first value: " firstValue  < $TTY
      read -p "second value: " secondValue < $TTY

      let SEQUENCE_NUMBER+=1
      echo "$#SEQUENCE_NUMBER correct:" $INTENSITY1 "to" $INTENSITY2 >> $STATISTIC_LOG
      echo -e "#SEQUENCE_NUMBER guessed:" $firstValue "to" $secondValue "\n" >> $STATISTIC_LOG
    fi

    read -n1 -p "press a key to continue" start < $TTY
  done <$2
}

function runStatistic {
  echo -e "$ACTYATOR_TYPE" >> $STATISTIC_LOG
  echo "-------------------------------------" >> $STATISTIC_LOG

  echo -e "\ncalibration phase: you will feel two stimulation  levels"
  echo -e "    of the actuator. The values will appear accordingly.\n"
  read -n1 -p "press any key to start" start

  for CALIBRATE_FILE in execution/$ACTYATOR_TYPE/calibrate*.txt; do
    printResolution $CALIBRATE_FILE
    echo "Ask the supervisors what $CALIBRATE_FILE means ;)"
    runBatchFile "showValues" $CALIBRATE_FILE
  done

  echo -e "\ntest phase: please first try to  feel the start  and end"
  echo "        level of stimmulation, then enter the values you"
  echo -e "        think you have felt.\n"
  read -n1 -p "press any key to start" start

  for TEST_FILE in execution/$ACTYATOR_TYPE/test*.txt; do
    printResolution $TEST_FILE
    runBatchFile "test" $TEST_FILE
  done
}
